----

# **áµ€ æœ¬è´¨é€è§†é•œ**
**æœ¬è´¨æ˜¯ï¼šæµè§ˆå™¨ç¯å¢ƒä¸­å®ç°å­åº”ç”¨è¿è¡Œéš”ç¦»ä¸é€šä¿¡çš„æ§åˆ¶å®¹å™¨**ã€‚

---

## **á´¼ å…³ç³»æ‹“æ‰‘å›¾**
```plain
[å­åº”ç”¨ JS] â†’[æ²™ç®± Proxy] â†’ æ§åˆ¶è®¿é—® window  
[å­åº”ç”¨ CSS] â†’[æ ·å¼ä½œç”¨åŸŸå°è£…] â†’ é¿å…æ±¡æŸ“ä¸»åº”ç”¨  
[äº‹ä»¶/é€šä¿¡] â†’[å®‰å…¨ä¿¡é“ postMessage] â†’ å®ç°ä¸»å­é€šä¿¡
```

---

## **á´¿ è¡ŒåŠ¨æ„ä¹‰é”®ç‚¹**
  


**æ ¸å¿ƒä»·å€¼æ˜¯ï¼šå®ç°å¤šå­åº”ç”¨çš„å®‰å…¨æ‰˜ç®¡ä¸ç‹¬ç«‹è¿è¡Œ**ã€‚

+ é¿å…å…¨å±€æ±¡æŸ“ / çŠ¯è§„è®¿é—® / å†…å­˜æ³„æ¼
+ æ”¯æŒ iframe / é iframe åˆ‡æ¢
+ å®¹æ˜“é›†æˆæƒé™ã€æ€§èƒ½ç›‘æ§

---

## **á´¾ æ­¥éª¤æ‹†è§£å™¨**
### **1. JS éš”ç¦»ï¼šProxy + with**
```plain
const fakeWindow = Object.create(null)
const proxy = new Proxy(window, {
  get(target, key) {
    if (key in fakeWindow) return fakeWindow[key]
    return Reflect.get(target, key)
  },
  set(target, key, value) {
    fakeWindow[key] = value
    return true
  }
})
```

<font style="color:#0e0e0e;">å°†å­åº”ç”¨ JS ä»¥ </font><font style="color:#0e0e0e;">with(proxy)</font><font style="color:#0e0e0e;"> æ‰©å±•åŸŸæ‰§è¡Œã€‚</font>

---

### **2. CSS æ ·å¼éš”ç¦»ï¼šScoped CSS**
```plain
<div id="micro-app1">
  <style scoped>
    .btn { color: red; }
  </style>
</div>
```

<font style="color:#0e0e0e;">æˆ–è€…åç¼€å¤„ç†æ ·å¼é€‰æ‹©å™¨å®ç°æ ·å¼æ²™ç®±åŒ–</font>

---

### **3. ç”Ÿå‘½å‘¨æœŸé’©å­**
```plain
export async function loadApp(url: string) {
  const html = await fetch(url).then(res => res.text())
  const { mount, unmount } = parseHtmlAndExtractLifecycle(html)
  mount(proxy)
}
```

---

### **4. ä¸»å­é€šä¿¡ï¼špostMessage**
```plain
// ä¸»åº”ç”¨
window.addEventListener('message', e => {
  if (e.data.from === 'subApp') console.log(e.data.payload)
})

// å­åº”ç”¨
window.parent.postMessage({ from: 'subApp', payload: { count: 1 } }, '*')
```

---

### **5. å­åº”ç”¨åŠ è½½ + èµ„æºéš”ç¦»**
```plain
const script = document.createElement('script')
script.src = 'https://sub-app.com/main.js'
sandboxContainer.appendChild(script)
```

<font style="color:#0e0e0e;">é…åˆ CSP + ç¦æ­¢ eval ç­‰æªæ–½å¢å¼ºå®‰å…¨æ€§</font>

---

## **å¯¹æ¯”åˆ†æè¡¨**
| **ç‰¹æ€§** | **æ‰‹å†™æ²™ç®±** | **qiankun** |
| --- | --- | --- |
| JS éš”ç¦» | âœ… Proxy + with | âœ… snapshot æ²™ç®± |
| CSS éš”ç¦» | âœ… scoped/åç¼€å¤„ç† | âœ… strict style åŠ å¼ºæ¨¡å¼ |
| ç”Ÿå‘½å‘¨æœŸ | âœ… mount/unmount | âœ… bootstrap/mount å®Œå¤‡ |
| DOM éš”ç¦» | âœ… å®šåˆ¶å®¹å™¨æ‰§è¡Œ | âœ… é»˜è®¤ DOM å®¹å™¨ |
| é€šä¿¡ | âœ… postMessage/custom | âœ… useGlobalState |
| iframe æ”¯æŒ | âœ… iframe åˆ‡æ¢ | âŒ é»˜è®¤ä¸æ”¯æŒ |
| å­¦ä¹ æˆæœ¬ | é«˜ï¼Œè‡ªå®šä¹‰å¼º | ä½ï¼Œä¸€è¡Œä»£ç è¿æ¥ |
| æ€§èƒ½/çµæ´»æ€§ | âœ… å¯æ§ï¼Œè½»é‡åŒ– | âŒ å†…éƒ¨å¤„ç†è¾ƒé‡ |


---

## **å®é™…é¡¹ç›®æ­é…**
```plain
ğŸ“ main-app/
  â”œâ”€ micro-loader.ts       // å­åº”ç”¨åŠ è½½å™¨
  â”œâ”€ sandbox.ts            // æ²™ç®±å®ç°
  â”œâ”€ messaging.ts          // ä¸»å­é€šä¿¡
  â””â”€ views/
      â””â”€ AppContainer.vue  // å­åº”ç”¨å®¹å™¨

ğŸ“ sub-app/
  â””â”€ expose.ts             // ç”Ÿå‘½å‘¨æœŸæŠ˜æ‹©ç‚¹ mount/unmount
```

---

## **ç»“è¯­**
<font style="color:#0e0e0e;">æ‰‹å†™æ²™ç®±ä¸æ˜¯ä¸ºäº†æ›¿ä»£ qiankunï¼Œè€Œæ˜¯ä¸ºäº†æ›´å¥½ç†è§£â€œå¾®å‰ç«¯â€çš„æœ¬è´¨</font>



+ æ²™ç®±æ˜¯è§£å†³åº”ç”¨åˆ†æ­£ä¸å®‰å…¨éš”ç¦»çš„æ ¸å¿ƒæŠ€æœ¯
+ qiankun æ˜¯æ„å»ºå¾®å‰ç«¯å¹³å°çš„ä¼˜ç§€å·¥ç¨‹åŒ–æ¡†æ¶
+ ä¸ºç‰¹æ®Šåœºæ™¯æˆ–å°å‹é¡¹ç›®æ¨èè‡ªå®šä¹‰æ²™ç®±



```html
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>å¾®å‰ç«¯æ²™ç®±æ¼”ç¤º</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }

      .app-container {
        border: 1px solid #ccc;
        margin-bottom: 20px;
        padding: 10px;
      }

      .micro-app-a h2 {
        color: red;
      }

      .micro-app-b h2 {
        color: green;
      }

      button {
        margin: 4px;
      }
    </style>
  </head>
  <body>
    <h1>ä¸»åº”ç”¨</h1>

    <div>
      <button onclick="mountApp('A')">æŒ‚è½½å­åº”ç”¨ A</button>
      <button onclick="unmountApp('A')">å¸è½½å­åº”ç”¨ A</button>

      <button onclick="mountApp('B')">æŒ‚è½½å­åº”ç”¨ B</button>
      <button onclick="unmountApp('B')">å¸è½½å­åº”ç”¨ B</button>
    </div>

    <div id="app-A" class="app-container"></div>
    <div id="app-B" class="app-container"></div>

    <script>
      // ==== 1ï¸âƒ£ æ²™ç®±ç±» ====
      class MicroSandbox {
        constructor(name) {
          this.name = name
          this.fakeWindow = {}
          this.active = false

          const self = this

          this.proxy = new Proxy(window, {
            get(target, key) {
              return self.active ? (key in self.fakeWindow ? self.fakeWindow[key] : target[key]) : target[key]
            },
            set(target, key, value) {
              if (self.active) {
                self.fakeWindow[key] = value
              } else {
                target[key] = value
              }
              return true
            },
            has(target, key) {
              return key in self.fakeWindow || key in target
            },
          })
        }

        start() {
          this.active = true
          console.log(`[æ²™ç®±:${this.name}] å¯åŠ¨`)
        }

        stop() {
          this.active = false
          this.fakeWindow = {}
          console.log(`[æ²™ç®±:${this.name}] åœæ­¢`)
        }

        getProxy() {
          return this.proxy
        }
      }

      // ==== 2ï¸âƒ£ æ ·å¼ä½œç”¨åŸŸå°è£… ====
      function scopeCSS(cssText, scopeClass) {
        return cssText.replace(/([^\r\n,{}]+)(,(?=[^}]*{)|\s*{)/g, (match, selector, brace) => {
          if (selector.includes(`.${scopeClass}`)) return match
          return `.${scopeClass} ${selector}${brace}`
        })
      }

      // ==== 3ï¸âƒ£ å­åº”ç”¨å®šä¹‰ ====
      const microApps = {
        A: {
          container: "app-A",
          class: "micro-app-a",
          html: `<div><h2>æˆ‘æ˜¯å­åº”ç”¨ A</h2><p>testGlobal = <span id="val-A"></span></p></div>`,
          style: `h2 { font-size: 22px; }`,
          script: `
          proxy.testGlobal = "A123"
          document.getElementById("val-A").innerText = proxy.testGlobal
        `,
        },
        B: {
          container: "app-B",
          class: "micro-app-b",
          html: `<div><h2>æˆ‘æ˜¯å­åº”ç”¨ B</h2><p>testGlobal = <span id="val-B"></span></p></div>`,
          style: `h2 { font-size: 18px; }`,
          script: `
          proxy.testGlobal = "B456"
          document.getElementById("val-B").innerText = proxy.testGlobal
        `,
        },
      }

      const sandboxes = {}

      // ==== 4ï¸âƒ£ æŒ‚è½½å‡½æ•° ====
      function mountApp(name) {
        const app = microApps[name]
        const container = document.getElementById(app.container)

        if (!sandboxes[name]) {
          sandboxes[name] = new MicroSandbox(name)
        }

        const sandbox = sandboxes[name]
        sandbox.start()
        const proxy = sandbox.getProxy()

        container.className = `app-container ${app.class}`
        container.innerHTML = app.html

        // åŠ¨æ€æ’å…¥ scoped style
        const scopedStyle = scopeCSS(app.style, app.class)
        const styleEl = document.createElement("style")
        styleEl.textContent = scopedStyle
        container.appendChild(styleEl)

        // ç”¨ proxy ä½œä¸ºæ²™ç®±ç¯å¢ƒæ‰§è¡Œä»£ç 
        const scriptFn = new Function("proxy", app.script)
        scriptFn(proxy)
      }

      // ==== 5ï¸âƒ£ å¸è½½å‡½æ•° ====
      function unmountApp(name) {
        const app = microApps[name]
        const container = document.getElementById(app.container)
        container.innerHTML = ""
        if (sandboxes[name]) sandboxes[name].stop()
      }
    </script>
  </body>
</html>

```

