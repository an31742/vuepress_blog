---
title: 闭包
icon: object-group
tag:
  - 面试必考
---

### Vue2 与 Vue3 核心区别深度解析  

---

#### 1. **响应式系统重构**（核心差异）  
| **特性**         | Vue2 (Object.defineProperty)       | Vue3 (Proxy)                      |  
|------------------|------------------------------------|-----------------------------------|  
| **原理**         | 递归遍历对象属性，用 getter/setter 劫持 | 代理整个对象，动态拦截任意操作         |  
| **数组监听**     | 需重写数组方法（push/pop等）         | 原生支持数组索引/长度变化             |  
| **新增属性**     | `Vue.set()` 强制添加响应式          | 直接赋值自动响应                    |  
| **性能**         | 初始化递归全量遍历，大对象性能差      | 按需代理，内存占用减少 40%+          |  
| **嵌套对象**     | 递归初始化所有层级                   | 惰性代理（访问时才递归）              |  

```javascript
// Vue3 响应式原理核心
const reactive = (target) => {
  return new Proxy(target, {
    get(obj, key) { 
      track(obj, key); // 依赖收集
      return Reflect.get(obj, key); 
    },
    set(obj, key, value) {
      Reflect.set(obj, key, value);
      trigger(obj, key); // 触发更新
    }
  });
};
```

---

#### 2. **Composition API 革命**  
**解决痛点**：  
- Options API 在复杂组件中逻辑分散（data/methods/watch 分离）  
- 更好的逻辑复用（替代 mixins）  

**核心对比**：  
```vue
<!-- Vue2 Options API -->
<script>
export default {
  data() { return { count: 0 } },
  methods: { increment() { this.count++ } },
  mounted() { console.log('Vue2 mounted') }
}
</script>

<!-- Vue3 Composition API -->
<script setup>
import { ref, onMounted } from 'vue';

const count = ref(0);
const increment = () => count.value++;

onMounted(() => {
  console.log('Vue3 mounted');
});
</script>
```

**优势**：  
- 逻辑关注点聚合（相关代码集中书写）  
- 类型推导友好（更适合 TS）  
- 逻辑复用能力（自定义 Hook）  
  ```javascript
  // useCounter.js
  import { ref } from 'vue';
  export default () => {
    const count = ref(0);
    const increment = () => count.value++;
    return { count, increment };
  };
  ```

---

#### 3. **性能与包体积优化**  
| **指标**         | Vue2        | Vue3           | 提升幅度 |  
|------------------|-------------|----------------|----------|  
| **打包体积**     | ~20KB       | ~10KB (gzip)   | 41%↓     |  
| **渲染速度**     | 基准 1x     | 1.3x-2x        | 30-100%↑ |  
| **更新性能**     | 基准 1x     | 2x             | 100%↑    |  
| **内存占用**     | 基准 1x     | 0.5x           | 50%↓     |  

**关键技术**：  
- 虚拟 DOM 重写（动静节点标记，diff 跳过静态子树）  
- Tree-shaking 支持（按需引入 API，如 `import { ref } from 'vue'`）  
- 编译器优化（Block tree / Patch flag）  

---

#### 4. **架构与新特性**  
| **特性**          | Vue2 支持          | Vue3 新增/增强               |  
|-------------------|--------------------|-----------------------------|  
| **Fragment**      | 单根节点限制       | 多根节点支持（减少无用 div） |  
| **Teleport**      | 无                 | `<Teleport to="body">`      |  
| **Suspense**      | 无                 | 异步组件加载状态管理         |  
| **自定义渲染器**  | 有限支持           | 标准化渲染器 API（Canvas/Native） |  
| **v-model**       | 单个组件仅支持一个 | 支持多个 `v-model:xxx`      |  

```vue
<!-- Vue3 多 v-model 示例 -->
<UserForm 
  v-model:name="userName"
  v-model:age="userAge"
/>
```

---

#### 5. **TypeScript 支持**  
| **维度**         | Vue2                     | Vue3                          |  
|------------------|--------------------------|-------------------------------|  
| **类型推断**     | 需 vue-class-component   | 原生支持 Composition API      |  
| **TSX 支持**     | 第三方插件               | 官方内置支持                  |  
| **类型定义**     | Options API 类型困难     | 基于泛型的完整类型推导        |  

```typescript
// Vue3 + TS 完美类型推断
import { defineComponent, ref } from 'vue';

export default defineComponent({
  setup() {
    const count = ref(0); // 自动推断为 Ref<number>
    const increment = () => count.value++; 
    return { count, increment };
  }
});
```

---

#### 6. **迁移策略与兼容性**  
- **渐进迁移**：  
  - 使用 `@vue/compat` 构建兼容版本（警告模式）  
  - 逐步替换 Options API → Composition API  
- **破坏性变更**：  
  - 事件总线（`$on/$off` 移除）→ 用 mitt 替代  
  - 过滤器（`| filter` 移除）→ 用 methods/computed 替代  
  - 生命周期更名（`destroyed` → `unmounted`）  
- **工具链更新**：  
  - Vue CLI → Vite 推荐  
  - Vuex 3 → Pinia 推荐  

---

#### 7. **最佳实践总结**  
1. **新项目**：  
   - 首选 Vue3 + Vite + Pinia + Composition API  
   - 复杂逻辑使用自定义 Hook 替代 mixins  
2. **老项目迁移**：  
   - 优先重构高频使用组件  
   - 利用 `<script setup>` 语法糖简化代码  
3. **性能关键路径**：  
   - 用 `ref` 替代 `reactive`（更细粒度控制）  
   - 列表渲染始终指定 `key`  
4. **生态搭配**：  
   - 状态管理：Pinia（官方推荐）  
   - 路由：Vue Router 4  
   - SSR：ViteSSR / Nuxt 3  

> **核心价值**：Vue3 通过响应式重写、Composition API 和性能优化，解决了大型应用的可维护性和性能瓶颈，同时保持渐进式框架的灵活性和低门槛。